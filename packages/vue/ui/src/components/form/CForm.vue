<script setup lang="ts">
import useFormProps from './useFormProps'
import CFormItem from './CFormItem.vue'
import type { Component } from 'vue'
import type { CRule } from 'casual-types'
import { useDefaultVModel } from '../../usable/useVModel'
import { CRadio } from 'casual-ui-vue'

interface Option {
  value: string | number
  label: string
}

type FormItemComponent =
  | 'input'
  | 'select'
  | 'checkbox'
  | 'checkbox-group'
  | 'radio'
  | 'date-picker'
  | 'toggle'
  | Component

/**
 * 表单项配置
 */
interface CFormItemConfig {
  /**
   * 表单项类型，对应需要渲染的组件
   */
  component?: FormItemComponent
  /**
   * 需要传递给组件的额外props
   */
  componentProps?: object
  /**
   * 对应表单数据字段名称
   */
  field: string
  /**
   * 表单项文案提示
   */
  label?: string
  /**
   * 验证规则
   */
  rules?: CRule[]
  /**
   * 选项数组，当component为select、radio、checkbox-group时生效
   */
  options?: Option[]
}

interface CFormProps {
  /**
   * 表单项配置
   */
  items?: CFormItemConfig[]
  /**
   * 表单绑定值，用于<code>v-model</code>
   */
  modelValue: object
  /**
   * 表单项提示文案长度
   */
  labelWidth?: string
  /**
   * 每个表单项占用的列数
   */
  col?: number
  /**
   * 文本排列方向，表现为flex-direction的对应值
   */
  labelDirection: 'row' | 'row-reverse' | 'column' | 'column-reverse'
}

const emit = defineEmits<{
  /**
   * 表单绑定值变化时触发
   */
  (e: 'update:modelValue', value: object): void
}>()

const props = withDefaults(defineProps<CFormProps>(), {
  items: () => [],
  labelWidth: '100px',
  col: 6,
})

const innerValue = useDefaultVModel(props, emit)
const { size } = useFormProps(props)

// 决定渲染何种组件，默认渲染输入框
const getComponent = (component?: FormItemComponent) => {
  if (!component) return 'c-input'
  if (typeof component === 'string') {
    return `c-${component}`
  }
  return component
}
</script>
<template>
  <div
    :class="['c-form', 'c-row', 'c-items-center', 'c-wrap', `c-gutter-${size}`]"
  >
    <c-form-item v-for="item in items" :key="item.field" :label="item.label">
      <!-- 
        @slot  
        @name [field] 表单项的自定义内容
      -->
      <slot :name="item.field">
        <template
          v-if="
            item.component === 'radio' &&
            item.options &&
            item.options.length > 0
          "
        >
          <div class="c-flex c-items-center" :class="[`c-gutter-${size}`]">
            <div v-for="{ label, value } in item.options" :key="value">
              <c-radio
                v-model="innerValue[item.field]"
                :label="label"
                :value="value"
              />
            </div>
          </div>
        </template>
        <Component
          :is="getComponent(item.component)"
          v-else
          v-model="innerValue[item.field]"
          v-bind="item.componentProps"
        />
      </slot>
    </c-form-item>
  </div>
</template>
